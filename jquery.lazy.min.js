(function($,window,document,undefined){var _scrollListener,_resizeListener;var $window=$(window);$.fn.lazy=function(settings){"use strict";var _configuration={bind:"load",threshold:500,fallbackWidth:2e3,fallbackHeight:2e3,visibleOnly:false,appendScroll:window,scrollDirection:"both",defaultImage:"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",placeholder:null,delay:-1,combined:false,attribute:"data-src",retinaAttribute:"data-retina",removeAttribute:true,handledName:"handled",effect:"show",effectTime:0,enableThrottle:false,throttle:250,enableQueueing:true,beforeLoad:null,onLoad:null,afterLoad:null,onError:null,onFinishedAll:null},_items=this,_awaitingAfterLoad=0,_actualWidth=-1,_actualHeight=-1,_isRetinaDisplay=false,_queueTimer=null,_queueItems=[],_queueContainsMagic=false;function _init(){_isRetinaDisplay=window.devicePixelRatio>1;if(_configuration.defaultImage!==null||_configuration.placeholder!==null)for(var i=0;i<_items.length;i++){var element=$(_items[i]);if(_configuration.defaultImage!==null&&!element.attr("src"))element.attr("src",_configuration.defaultImage);if(_configuration.placeholder!==null&&(!element.css("background-image")||element.css("background-image")=="none"))element.css("background-image","url("+_configuration.placeholder+")")}if(_configuration.delay>=0)setTimeout(function(){_lazyLoadImages(true)},_configuration.delay);if(_configuration.delay<0||_configuration.combined){_lazyLoadImages(false);_addToQueue(function(){_scrollListener=_throttle(_configuration.throttle,function(){_addToQueue(function(){_lazyLoadImages(false)},this,true)});$(_configuration.appendScroll).bind("scroll",_scrollListener)},this);_addToQueue(function(){_resizeListener=_throttle(_configuration.throttle,function(){_actualWidth=_actualHeight=-1;_addToQueue(function(){_lazyLoadImages(false)},this,true)});$(_configuration.appendScroll).bind("resize",_resizeListener)},this)}}function _lazyLoadImages(allImages){if(!_items.length)return;var loadedImages=false;for(var i=0;i<_items.length;i++){(function(){var item=_items[i],element=$(item);if(_isInLoadableArea(item)||allImages){var tag=item.tagName.toLowerCase();if(element.attr(_configuration.attribute)&&(tag=="img"&&element.attr(_configuration.attribute)!=element.attr("src")||tag!="img"&&element.attr(_configuration.attribute)!=element.css("background-image"))&&!element.data(_configuration.handledName)&&(element.is(":visible")||!_configuration.visibleOnly)){loadedImages=true;element.data(_configuration.handledName,true);_addToQueue(function(){_handleItem(element,tag)},this)}}})()}if(loadedImages)_addToQueue(function(){_items=$(_items).filter(function(){return!$(this).data(_configuration.handledName)})},this)}function _handleItem(element,tag){var imageObj=$(new Image);++_awaitingAfterLoad;if(_configuration.onError)imageObj.error(function(){_triggerCallback(_configuration.onError,element);_reduceAwaiting()});else imageObj.error(function(){_reduceAwaiting()});var onLoad=false;imageObj.one("load",function(){var callable=function(){if(!onLoad){window.setTimeout(callable,100);return}element.hide();if(tag=="img")element.attr("src",imageObj.attr("src"));else element.css("background-image","url("+imageObj.attr("src")+")");element[_configuration.effect](_configuration.effectTime);if(_configuration.removeAttribute){element.removeAttr(_configuration.attribute);element.removeAttr(_configuration.retinaAttribute)}_triggerCallback(_configuration.afterLoad,element);imageObj.unbind("load").remove();_reduceAwaiting()};callable()});_triggerCallback(_configuration.beforeLoad,element);imageObj.attr("src",_isRetinaDisplay&&element.attr(_configuration.retinaAttribute)?element.attr(_configuration.retinaAttribute):element.attr(_configuration.attribute));_triggerCallback(_configuration.onLoad,element);onLoad=true;if(imageObj.complete)imageObj.load()}function _isInLoadableArea(element){var inDOM=$.contains(document,element);if(inDOM){var $element=$(element);var scrollTop=$window.scrollTop();var scrollLeft=$window.scrollLeft();var windowWidth=$window.width();var windowHeight=$window.height();var offset=$(element).offset();var elTop=offset.top;var elLeft=offset.left;var elHeight=$element.height();var elWidth=$element.width();var buffer=_configuration.threshold;var inVerticalViewport=elTop+elHeight>scrollTop-buffer&&elTop<scrollTop+windowHeight+buffer;var inHorizontalViewport=elLeft+elWidth>scrollLeft-buffer&&elLeft<scrollLeft+windowWidth+buffer;if(_configuration.scrollDirection==="vertical"){return inVerticalViewport}else if(_configuration.scrollDirection==="horizontal"){return inHorizontalViewport}return inVerticalViewport&&inHorizontalViewport}else{return false}}function _getActualWidth(){return $window.width()}function _getActualHeight(){return $window.height()}function _throttle(delay,call){var _timeout,_exec=0;function callable(){var elapsed=+new Date-_exec;function run(){_exec=+new Date;call.apply(undefined)}_timeout&&clearTimeout(_timeout);if(elapsed>delay||!_configuration.enableThrottle)run();else _timeout=setTimeout(run,delay-elapsed)}return callable}function _reduceAwaiting(){--_awaitingAfterLoad;if(!_items.size()&&!_awaitingAfterLoad)_triggerCallback(_configuration.onFinishedAll,null)}function _triggerCallback(callback,element){if(callback){if(element)_addToQueue(function(){callback(element)},this);else _addToQueue(callback,this)}}function _setQueueTimer(){_queueTimer=setTimeout(function(){_addToQueue();if(_queueItems.length)_setQueueTimer()},2)}function _addToQueue(callable,context,isLazyMagic){if(callable){if(!_configuration.enableQueueing){callable.call(context||window);return}if(!isLazyMagic||isLazyMagic&&!_queueContainsMagic){_queueItems.push([callable,context,isLazyMagic]);if(isLazyMagic)_queueContainsMagic=true}if(_queueItems.length==1)_setQueueTimer();return}var next=_queueItems.shift();if(!next)return;if(next[2])_queueContainsMagic=false;next[0].call(next[1]||window)}function _disable(){if(_scrollListener){$(_configuration.appendScroll).unbind("scroll",_scrollListener)}if(_resizeListener){$(_configuration.appendScroll).unbind("resize",_resizeListener)}}(function(){if($.type(settings)==="string"){var command=settings;if(command==="disable"){return _disable()}else if(command==="fetchVisible"){return _lazyLoadImages(false)}}else{if(settings)$.extend(_configuration,settings);if(_configuration.onError)_items.each(function(){var item=this;_addToQueue(function(){$(item).bind("error",function(){_triggerCallback(_configuration.onError,$(this))})},item)});if(_configuration.bind=="load")$(_init);else if(_configuration.bind=="event")_init()}})();return this};$.fn.Lazy=$.fn.lazy})(jQuery,window,document);